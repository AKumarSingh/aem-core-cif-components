################################################################################
#
#    Copyright 2019 Adobe. All rights reserved.
#    This file is licensed to you under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License. You may obtain a copy
#    of the License at http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software distributed under
#    the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR REPRESENTATIONS
#    OF ANY KIND, either express or implied. See the License for the specific language
#    governing permissions and limitations under the License.
#
################################################################################

LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_connect_module modules/mod_proxy_connect.so
LoadModule proxy_http_module modules/mod_proxy_http.so

Define magento_hostname magento2.vagrant78
Define magento_url http://${magento_hostname}
Define proxy_hostname localhost

ProxyPass "/magento/graphql" "${magento_url}/graphql"
ProxyPassReverse "/magento/graphql" "${magento_url}/graphql"

ProxyPass "/magento/rest" "${magento_url}/rest"
ProxyPassReverse "/magento/rest" "${magento_url}/rest"

ProxyPass "/magento/img" "${magento_url}/media/catalog/product"
ProxyPassReverse "/magento/img" "${magento_url}/media/catalog/product"

# Checkout pages, including customer personalized content
ProxyPass "/magento/checkout" "${magento_url}/checkout"
ProxyPassReverse "/magento/checkout" "${magento_url}/checkout"
ProxyPass "/magento/customer" "${magento_url}/customer"
ProxyPassReverse "/magento/customer" "${magento_url}/customer"

# Required for assets loaded via the proxy, only used by the checkout page
# (this MUST not be removed because of CORS issues with JS scripts on the checkout page)
ProxyPass "/magento/pub" "${magento_url}/pub"
ProxyPassReverse "/magento/pub" "${magento_url}/pub"

# Ensures cookies set by Magento are set for the proxy hostname
ProxyPassReverseCookieDomain "${magento_hostname}" "${proxy_hostname}"

# We do some HTML replacement for the checkout page
LoadModule deflate_module modules/mod_deflate.so
LoadModule substitute_module modules/mod_substitute.so
LoadModule sed_module modules/mod_sed.so
<Location "/magento/checkout">
    AddOutputFilterByType INFLATE text/html
    AddOutputFilterByType SUBSTITUTE text/html
    AddOutputFilterByType Sed text/html
    AddOutputFilterByType DEFLATE text/html

    # We first uncompress the content coming from Magento, do the substitutions, and then compress the content again
    SetOutputFilter INFLATE;SUBSTITUTE;Sed;DEFLATE

    # Replaces all instances of the Magento hostname with the proxy hostname
    Substitute "s|${magento_hostname}|${proxy_hostname}/magento|ni"

    # 'mod_substitute' only works line-by-line, for multi-line, we use the more complex 'mod_sed' module
    # The config below removes the Magento header, footer, copyright, and category navigation
    # The parts before the many substitutions mean:
    # 1h  --> copy 1st line to hold buffer
    # 1!H --> append all other lines to hold buffer
    # $!d --> delete all lines except last one
    # $x  --> replace last line with hold buffer (which contains all the lines)
    # Then all substitution rules only apply to the last line (because of leading $)
    OutputSed "1h;1!H;$!d;$x;\
        $s|<header class=\"page-header\">.*</header>||;\
        $s|<footer class=\"page-footer\">.*</footer>||;\
        $s|<small class=\"copyright\">.*</small>||;\
        $s|<nav class=\"navigation\" data-action=\"navigation\">.*</nav>||"
</Location>
